<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Lucky Match ç½‘é¡µç‰ˆ</title>
<style>
body {
    font-family: "å¾®è½¯é›…é»‘", sans-serif;
    background-color: #f8f8ff;
    text-align: center;
    margin: 0;
    padding: 0;
}
h1 { margin-top: 20px; }
#luck-select, #game-area, #history-modal { display: none; }
.grid { display: grid; grid-template-columns: repeat(3, 120px); gap: 15px; justify-content: center; margin-top: 30px; }
.card {
    border: 3px solid #000;
    border-radius: 10px;
    overflow: hidden;
    width: 110px;
    height: 110px;
    background-color: #fff;
    cursor: pointer;
    transition: border-color 0.2s;
}
.card img { width: 110px; height: 110px; }
#info { font-size: 18px; margin: 15px; }
#action { color: #007744; font-size: 16px; margin-bottom: 15px; }
button { font-size: 15px; padding: 8px 18px; margin: 5px; border-radius: 8px; cursor: pointer; border: none; }
#draw-btn { background-color: #fff3cd; }
#reset-btn { background-color: #f8d7da; }
#history-btn { background-color: #d1ecf1; }
#history-modal {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #ffffff;
    border: 2px solid #aaa;
    border-radius: 12px;
    width: 400px; height: 400px;
    overflow-y: auto; padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
#history-modal h3 { margin-top: 0; }
#history-modal button { background-color: #f8d7da; margin-top: 10px; }
</style>
</head>
<body>

<h1>ğŸ´ Lucky Match æ¸¸æˆ</h1>

<div id="luck-select">
    <p style="font-size:18px;">è¯·é€‰æ‹©ä½ çš„å¹¸è¿ç‰Œï¼š</p>
    <div class="grid" id="luck-grid"></div>
</div>

<div id="game-area">
    <div id="info"></div>
    <div class="grid" id="cards"></div>
    <div id="action"></div>
    <div>
        <button id="draw-btn">è¡¥ç‰Œ (0)</button>
        <button id="reset-btn">è¿”å›é€‰æ‹©Luck</button>
        <button id="history-btn">å†å²è®°å½•</button>
    </div>
</div>

<div id="history-modal">
    <h3>ğŸ“œ å†å²å¾—åˆ†è®°å½•</h3>
    <div id="history-list"></div>
    <button id="close-history">å…³é—­</button>
</div>

<script>
let deck = [], gameArea = [], score = 0, drawChance = 0;
let luck = null, finished = false, historyScores = [], animating = false;

function initGame(selectedLuck) {
    deck = [];
    for (let v = 1; v <= 9; v++) for (let i=0;i<7;i++) deck.push(v);
    shuffle(deck);
    gameArea = deck.splice(0, 9).map(v=>({v}));
    score = 0; drawChance = 0; luck = selectedLuck; finished = false; animating = false;
    document.getElementById("luck-select").style.display = "none";
    document.getElementById("game-area").style.display = "block";
    updateUI("æ¸¸æˆå¼€å§‹");
    setTimeout(autoStep, 300);
}

function shuffle(array) {
    for (let i=array.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [array[i],array[j]]=[array[j],array[i]];
    }
}

function drawCards() {
    const cardsDiv = document.getElementById("cards");
    cardsDiv.innerHTML = "";
    gameArea.forEach(c => {
        const div = document.createElement("div");
        div.className = "card";
        if (c.v===luck) div.style.borderColor="#ff0000";
        const img = document.createElement("img");
        img.src = `${c.v}.png`;
        div.appendChild(img);
        cardsDiv.appendChild(div);
    });
}

function updateUI(actionText){
    document.getElementById("info").innerText=`${score}ç¢°`;
    const actionEl=document.getElementById("action");
    actionEl.innerText=`åŠ¨ä½œï¼š${actionText}`;
    actionEl.style.color=finished?"#ff0000":"#007744";
    document.getElementById("draw-btn").innerText=`è¡¥ç‰Œ (${drawChance})`;
    drawCards();
}

function flashAndRemove(matchedValue, callback) {
    if (animating) return;
    animating = true;
    let flashes = 0;

    // æ‰¾å‡ºè¦é—ªçƒçš„å‰ä¸¤å¼ ç‰Œçš„ç´¢å¼•
    const cardDivs = Array.from(document.getElementById("cards").children);
    const indicesToRemove = [];
    for (let i = 0; i < gameArea.length && indicesToRemove.length < 2; i++) {
        if (gameArea[i].v === matchedValue) indicesToRemove.push(i);
    }

    function flashCycle() {
        if (flashes >= 3) {
            // ç§»é™¤å‰ä¸¤å¼ ç‰Œ
            // ä»åå¾€å‰åˆ é™¤ï¼Œé¿å…ç´¢å¼•é”™ä½
            for (let i = indicesToRemove.length - 1; i >= 0; i--) {
                gameArea.splice(indicesToRemove[i], 1);
            }
            animating = false;
            updateUI(`åŒ¹é…æˆåŠŸï¼š${matchedValue}ï¼Œå¾—åˆ† +1ï¼Œè¡¥ç‰Œæœºä¼š +1`);
            callback();
            return;
        }

        // é—ªçƒæ•ˆæœ
        indicesToRemove.forEach(idx => {
            const div = cardDivs[idx];
            div.style.borderColor = div.style.borderColor === "#ffcc00" ? "#000000" : "#ffcc00";
        });

        flashes++;
        setTimeout(flashCycle, 300);
    }

    flashCycle();
}

function autoStep(){
    if(finished || animating) return;

    // luckè§¦å‘
    gameArea.forEach(c => {
        if(c.v===luck && !c.luckTriggered){
            c.luckTriggered=true;
            drawChance++;
            updateUI(`Luckç‰Œ ${luck} è§¦å‘è¡¥ç‰Œæœºä¼šï¼`);
        }
    });

    // åŒ¹é…æ£€æµ‹
    const counts={};
    gameArea.forEach(c=>counts[c.v]=(counts[c.v]||0)+1);
    const pairs = Object.keys(counts).filter(v=>counts[v]>=2);
    if(pairs.length>0){
        const chosen=parseInt(pairs[Math.floor(Math.random()*pairs.length)]);
        score++; drawChance++;
        flashAndRemove(chosen, ()=>setTimeout(autoStep,400));
    }else{
        if(drawChance===0){
            finished=true;
            updateUI("æ— å¯åŒ¹é…ç‰Œä¸”æ— è¡¥ç‰Œæœºä¼šï¼Œæ¸¸æˆç»“æŸ");
            saveHistory();
        }else{
            updateUI("æ— å¯åŒ¹é…ç‰Œï¼Œè¯·æ‰‹åŠ¨è¡¥ç‰Œ");
        }
    }
}

// è¡¥ç‰Œ
document.getElementById("draw-btn").onclick = function(){
    if(finished || animating) return;
    if(drawChance<=0){ updateUI("æ²¡æœ‰è¡¥ç‰Œæœºä¼šï¼"); return;}
    if(gameArea.length>=9){ updateUI("åœºä¸Šå·²æ»¡ï¼Œæ— æ³•è¡¥ç‰Œï¼"); return;}
    if(deck.length===0){ updateUI("ç‰Œå †å·²ç©ºï¼Œæ— æ³•è¡¥ç‰Œï¼"); return;}
    drawChance--;
    const newCard=deck.pop();
    gameArea.push({v:newCard});
    updateUI(`ç©å®¶è¡¥ç‰Œ`);
    setTimeout(autoStep,200);
};

document.getElementById("reset-btn").onclick = function(){
    if(!finished && score>0) saveHistory();
    document.getElementById("luck-select").style.display="block";
    document.getElementById("game-area").style.display="none";
};

document.getElementById("history-btn").onclick=function(){
    const modal=document.getElementById("history-modal");
    const list=document.getElementById("history-list");
    list.innerHTML="";
    if(historyScores.length===0){ list.innerHTML="<p>æš‚æ— å†å²è®°å½•</p>"; }
    else{ historyScores.forEach((h,i)=>list.innerHTML+=`<p>ç¬¬${i+1}å±€ | ${h.time} | ${h.score}ç¢°</p>`);}
    modal.style.display="block";
};
document.getElementById("close-history").onclick = ()=>document.getElementById("history-modal").style.display="none";

function saveHistory(){
    historyScores.push({score,luck,time:new Date().toLocaleString()});
}

// åˆå§‹åŒ– Luck é€‰æ‹©ç•Œé¢
window.onload = function(){
    const grid=document.getElementById("luck-grid");
    for(let i=1;i<=9;i++){
        const div=document.createElement("div");
        div.className="card";
        div.innerHTML=`<img src="${i}.png">`;
        div.onclick=()=>initGame(i);
        grid.appendChild(div);
    }
    document.getElementById("luck-select").style.display="block";
};
</script>

</body>
</html>
